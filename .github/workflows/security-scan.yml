name: Security Scan and PR Creation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  security-events: write
  pull-requests: write
  actions: read

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Install Security Tools
        run: |
          # Install Trivy
          sudo apt-get update
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy
          
          # Install Snyk
          npm install -g snyk
          
          # Install jq for JSON processing
          sudo apt-get install jq

      - name: Run Trivy Scan
        run: |
          echo "üîç Running Trivy security scan..."
          mkdir -p security-results
          
          # Filesystem scan - JSON format
          trivy fs --format json --output security-results/trivy-fs.json . || true
          
          # Filesystem scan - SARIF format for GitHub Security tab
          trivy fs --format sarif --output security-results/trivy-fs.sarif . || true
          
          # Repository scan - JSON format
          trivy repo --format json --output security-results/trivy-repo.json . || true
          
          # Repository scan - SARIF format for GitHub Security tab
          trivy repo --format sarif --output security-results/trivy-repo.sarif . || true
          
          echo "‚úÖ Trivy scan completed"

      - name: Run Snyk Scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "üîç Running Snyk security scan..."
          if [ -n "$SNYK_TOKEN" ]; then
            snyk auth $SNYK_TOKEN
            # JSON format for reporting
            snyk test --json > security-results/snyk-test.json || true
            # SARIF format for GitHub Security tab
            snyk test --sarif > security-results/snyk-test.sarif || true
            snyk monitor || true
          else
            echo "‚ö†Ô∏è SNYK_TOKEN not provided - skipping Snyk scan"
            echo '{"vulnerabilities": [], "summary": {"total": 0}}' > security-results/snyk-test.json
            echo '{"version": "2.1.0", "runs": [{"tool": {"driver": {"name": "Snyk"}}, "results": []}]}' > security-results/snyk-test.sarif
          fi
          echo "‚úÖ Snyk scan completed"

      - name: Run OWASP Dependency Check
        if: hashFiles('pom.xml') != ''
        run: |
          echo "üîç Running OWASP Dependency Check..."
          mvn org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=0 \
            -Dformat=JSON \
            -DprettyPrint=true || true
          
          # Move results to security-results directory
          if [ -f "target/dependency-check-report.json" ]; then
            cp target/dependency-check-report.json security-results/owasp-dependency-check.json
          fi
          echo "‚úÖ OWASP scan completed"

      - name: Upload Trivy FS SARIF Results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('security-results/trivy-fs.sarif') != ''
        with:
          sarif_file: security-results/trivy-fs.sarif
          category: trivy-fs
        continue-on-error: true

      - name: Upload Trivy Repo SARIF Results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('security-results/trivy-repo.sarif') != ''
        with:
          sarif_file: security-results/trivy-repo.sarif
          category: trivy-repo
        continue-on-error: true

      - name: Upload Snyk SARIF Results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('security-results/snyk-test.sarif') != ''
        with:
          sarif_file: security-results/snyk-test.sarif
          category: snyk
        continue-on-error: true

      - name: Generate Security Report
        run: |
          echo "üìä Generating security report..."
          echo '<!DOCTYPE html><html><head><title>Security Scan Report</title><style>body{font-family:Arial,sans-serif;margin:20px;background:#1a1a1a;color:#fff}.header{background:#2d2d2d;padding:20px;border-radius:8px;margin-bottom:20px}.scanner{background:#333;padding:15px;margin:10px 0;border-radius:5px}.critical{border-left:5px solid #ff4444}</style></head><body><div class="header"><h1>üîí Security Scan Report</h1><p>Generated: '$(date)'</p><p>Repository: ${{ github.repository }}</p></div><div class="scanner critical"><h2>üö® Security Scan Completed</h2><p>Automated security scanning performed.</p><ul><li>Check GitHub Security tab</li><li>Review pipeline artifacts</li><li>Monitor for security PRs</li></ul></div></body></html>' > security-dashboard.html

      - name: Upload Security Results
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            security-results/
            security-dashboard.html
          retention-days: 30

  create-security-prs:
    name: Create Security PRs
    runs-on: ubuntu-latest
    needs: security-scan
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Check for Vulnerable Dependencies
        id: check_vulns
        run: |
          echo "üîç Checking for vulnerable dependencies..."
          
          NEEDS_UPDATE=false
          UPDATES=""
          
          # Check for vulnerable Spring Boot version
          if grep -q "<version>2\.5\.9</version>" pom.xml 2>/dev/null; then
            echo "Found vulnerable Spring Boot 2.5.9"
            NEEDS_UPDATE=true
            UPDATES="$UPDATES\n- Spring Boot 2.5.9 ‚Üí 2.7.18 (fixes Spring4Shell CVE-2022-22965)"
          fi
          
          # Check for vulnerable JJWT version  
          if grep -q "jjwt.*0\.9\.1" pom.xml 2>/dev/null; then
            echo "Found vulnerable JJWT 0.9.1"
            NEEDS_UPDATE=true
            UPDATES="$UPDATES\n- JJWT 0.9.1 ‚Üí 0.11.5 (fixes CVE-2019-7644)"
          fi
          
          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT
          echo "updates<<EOF" >> $GITHUB_OUTPUT
          echo -e "$UPDATES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Security Update PR
        if: steps.check_vulns.outputs.needs_update == 'true'
        run: |
          echo "üîß Creating security update PR..."
          
          # Configure git
          git config user.name "openhands"
          git config user.email "openhands@all-hands.dev"
          
          # Create branch
          BRANCH_NAME="security-updates-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          # Update Spring Boot if needed
          if grep -q "<version>2\.5\.9</version>" pom.xml; then
            sed -i 's/<version>2\.5\.9<\/version>/<version>2.7.18<\/version>/g' pom.xml
            echo "Updated Spring Boot to 2.7.18"
          fi
          
          # Update JJWT if needed
          if grep -q "jjwt.*0\.9\.1" pom.xml; then
            sed -i 's/\(<artifactId>jjwt<\/artifactId>\s*<version>\)0\.9\.1\(<\/version>\)/\10.11.5\2/g' pom.xml
            echo "Updated JJWT to 0.11.5"
          fi
          
          # Create security report
          echo "# Security Update Report" > SECURITY_UPDATE_REPORT.md
          echo "" >> SECURITY_UPDATE_REPORT.md
          echo "This PR fixes critical security vulnerabilities:" >> SECURITY_UPDATE_REPORT.md
          echo "${{ steps.check_vulns.outputs.updates }}" >> SECURITY_UPDATE_REPORT.md
          echo "" >> SECURITY_UPDATE_REPORT.md
          echo "Please test thoroughly before merging." >> SECURITY_UPDATE_REPORT.md
          
          # Commit changes
          git add pom.xml SECURITY_UPDATE_REPORT.md
          git commit -m "üîí Security Update: Fix critical vulnerabilities"
          
          # Push branch
          git push -u origin "$BRANCH_NAME"
          
          # Create PR
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" \
            -d "{
              \"title\": \"üîí Security Update: Fix critical vulnerabilities\",
              \"body\": \"Automated security update to fix critical vulnerabilities. See SECURITY_UPDATE_REPORT.md for details.\",
              \"head\": \"$BRANCH_NAME\",
              \"base\": \"main\"
            }"
          
          echo "‚úÖ Security PR created successfully"

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [security-scan, create-security-prs]
    if: always()
    
    steps:
      - name: Send Slack Notification
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "üì¢ Sending Slack notification..."
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "üîí Security Scan & PR Creation Completed",
                "attachments": [
                  {
                    "color": "${{ needs.security-scan.result == 'success' && 'good' || 'danger' }}",
                    "fields": [
                      {
                        "title": "Repository",
                        "value": "${{ github.repository }}",
                        "short": true
                      },
                      {
                        "title": "Scan Status", 
                        "value": "${{ needs.security-scan.result }}",
                        "short": true
                      }
                    ]
                  }
                ]
              }' \
              "$SLACK_WEBHOOK_URL"
            echo "‚úÖ Slack notification sent"
          else
            echo "‚ÑπÔ∏è Slack notifications are disabled (SLACK_WEBHOOK_URL not configured)"
            echo "To enable Slack notifications, add SLACK_WEBHOOK_URL to your repository secrets"
          fi